import { CustomContentDialog, LoadingDialog } from '@kit.ArkUI'
import { Emulator } from '../model/Emulator'
import { fileIo as fs } from '@kit.CoreFileKit'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { pasteboard, deviceInfo } from '@kit.BasicServicesKit'
import napi from 'libentry.so'
import { taskpool } from '@kit.ArkTS';
import { getSnapshotsTask, createSnapshotTask, applySnapshotTask, deleteSnapshotTask, optimizeImageTask, getImageInfoTask, needRestartTask } from '../utils/ImageTasks';
import appOption from '../model/appOption'

const DOMAIN = 0x0000

// åˆå§‹åŒ–ä»»åŠ¡çŠ¶æ€
AppStorage.setOrCreate(appOption.qemuImgTaskRunning, false)
AppStorage.setOrCreate(appOption.qemuImgTaskDescription, '')

/**
 * é•œåƒä¿¡æ¯æ¥å£
 */
interface ImageBasicInfo {
  name: string        // é•œåƒæ–‡ä»¶å
  path: string        // ç³»ç»Ÿè·¯å¾„ï¼ˆç¨‹åºä½¿ç”¨ï¼‰
  userPath: string    // ç”¨æˆ·ä¾§æ–‡ä»¶è·¯å¾„ï¼ˆç”¨æˆ·æŸ¥çœ‹ç”¨ï¼‰
  virtualSize: number // è™šæ‹Ÿå¤§å° (bytes)
  diskSize: number    // å®é™…å ç”¨ (bytes)
}

/**
 * é•œåƒè¯¦ç»†ä¿¡æ¯æ¥å£ï¼ˆæ¥è‡ª qemu-img infoï¼‰
 */
interface ImageDetailInfo {
  image: string
  fileFormat: string
  virtualSize: number
  diskSize: number
  clusterSize?: number
  lazyRefcounts?: boolean
  extendedL2?: boolean
  compressionType?: string
  compat?: string
  refcountBits?: number
  corrupt?: boolean
}

/**
 * å¿«ç…§ä¿¡æ¯æ¥å£
 */
interface SnapshotInfo {
  id: number
  name: string
  vm_size: number
  date: string
  vm_clock: string
}

/**
 * é•œåƒç®¡ç†å†…å®¹ç»„ä»¶
 * æ˜¾ç¤ºè™šæ‹Ÿæœºç£ç›˜é•œåƒçš„åŸºç¡€ä¿¡æ¯å’Œè¯¦ç»†ä¿¡æ¯
 */
@Component
export default struct ImageManagementContent {
  @Prop emulator: Emulator
  @Prop isVmRunning: boolean = false  // VM æ˜¯å¦è¿è¡Œä¸­
  @State basicInfo: ImageBasicInfo | null = null
  @State detailInfo: ImageDetailInfo | null = null
  @State isLoading: boolean = false
  @State errorMessage: string = ''
  @State showDetail: boolean = false
  
  // å¿«ç…§ç®¡ç†ç›¸å…³çŠ¶æ€
  @State snapshots: SnapshotInfo[] = []
  @State selectedSnapshots: Set<number> = new Set()
  @State isSnapshotLoading: boolean = false
  @State snapshotError: string = ''
  @State needRestart: boolean = false
  @State snapshotNameInput: string = ''  // å¿«ç…§åç§°è¾“å…¥
  @State isPC: boolean = false // æ˜¯å¦ä¸º PC/2in1 è®¾å¤‡
  
  // å…¨å±€ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª
  @StorageLink(appOption.qemuImgTaskRunning) globalTaskRunning: boolean = false
  @StorageLink(appOption.qemuImgTaskDescription) globalTaskDescription: string = ''
  
  private promptAction = this.getUIContext().getPromptAction()
  
  // ä¼˜åŒ–è¿›åº¦å¯¹è¯æ¡†æ§åˆ¶å™¨
  @State optimizeTaskMessage: string = ''
  private optimizeProgressDialog: CustomDialogController = new CustomDialogController({
    builder: LoadingDialog({
      content: this.optimizeTaskMessage
    }),
    autoCancel: false,  // ä¸å¯å…³é—­
    alignment: DialogAlignment.Center
  })
  
  // è¯¦æƒ…å¯¹è¯æ¡†æ§åˆ¶å™¨
  private detailDialogController: CustomDialogController = new CustomDialogController({
    builder: CustomContentDialog({
      primaryTitle: $r('app.string.image_details'),
      contentBuilder: () => {
        this.buildDetailContent()
      },
      buttons: [{
        value: $r('app.string.btn_close'),
        action: () => {
          this.detailDialogController.close()
        }
      }]
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center
  })

  // åˆ›å»ºå¿«ç…§å¯¹è¯æ¡†æ§åˆ¶å™¨
  private createSnapshotDialogController: CustomDialogController = new CustomDialogController({
    builder: CustomContentDialog({
      primaryTitle: $r('app.string.create_snapshot'),
      contentBuilder: () => {
        this.buildCreateSnapshotContent()
      },
      buttons: [
        {
          value: $r('app.string.setting_generic_cancel'),
          action: () => {
            this.createSnapshotDialogController.close()
          }
        },
        {
          value: $r('app.string.btn_create'),
          role: ButtonRole.NORMAL,
          action: () => {
            if (this.snapshotNameInput.trim()) {
              this.createSnapshot(this.snapshotNameInput.trim())
              this.createSnapshotDialogController.close()
            }
          }
        }
      ]
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center
  })
  
  // ä¼˜åŒ–æ¨¡å¼é€‰æ‹©å¯¹è¯æ¡†æ§åˆ¶å™¨
  private optimizeModeDialogController: CustomDialogController = new CustomDialogController({
    builder: CustomContentDialog({
      primaryTitle: $r('app.string.dialog_optimize_mode'),
      contentBuilder: () => {
        this.buildOptimizeModeContent()
      }
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center
  })

  aboutToAppear(): void {
    // æ£€æŸ¥è®¾å¤‡ç±»å‹ï¼Œä»… 2in1 è®¾å¤‡è§†ä¸º PC
    this.isPC = deviceInfo.deviceType === '2in1' || deviceInfo.deviceType === 'tablet'
    
    // å¼‚æ­¥åŠ è½½ï¼Œå…ˆåŠ è½½åŸºæœ¬ä¿¡æ¯ï¼Œå®Œæˆåå†åŠ è½½å¿«ç…§
    this.loadBasicInfoAsync().then(() => {
      this.loadSnapshotsAsync()
    })
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸º PC è®¾å¤‡ï¼Œå¦‚æœä¸æ˜¯åˆ™æç¤º
   */
  private checkPC(): boolean {
    if (!this.isPC) {
      this.promptAction.showToast({
        message: $r('app.string.msg_pc_only'),
        duration: 2000
      })
      return false
    }
    return true
  }




  /**
   * åŠ è½½åŸºç¡€é•œåƒä¿¡æ¯ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
   */
  private async loadBasicInfoAsync(): Promise<void> {
    const rootfsPath = this.emulator.rootFilesystem
    const context = this.getUIContext().getHostContext()?.getApplicationContext()
    const filesDir = context?.filesDir || ''
    const bundleName = context?.applicationInfo?.name || 'dev.hackeris.hish'
    const fullPath = rootfsPath.startsWith('/') ? rootfsPath : `${filesDir}/${rootfsPath}`
    
    try {
      // è·å–æ–‡ä»¶å
      const pathParts = fullPath.split('/')
      const fileName = pathParts[pathParts.length - 1]
      
      // ç”Ÿæˆç”¨æˆ·ä¾§æ–‡ä»¶è·¯å¾„
      let userPath = fullPath
      if (fullPath.includes('/data/storage/el2/base/')) {
        const relativePart = fullPath.replace('/data/storage/el2/base/', '')
        userPath = `/storage/Users/currentUser/appdata/el2/base/${bundleName}/${relativePart}`
      }
      
      // å¼‚æ­¥è¯»å–æ–‡ä»¶ä¿¡æ¯
      const stat = await fs.stat(fullPath)
      const diskSize = stat.size
      
      // å¼‚æ­¥è¯»å– QCOW2 è™šæ‹Ÿå¤§å°
      const virtualSize = await this.readQcow2VirtualSizeAsync(fullPath)
      
      this.basicInfo = {
        name: fileName,
        path: fullPath,
        userPath: userPath,
        virtualSize: virtualSize,
        diskSize: diskSize
      }
    } catch (e) {
      hilog.error(DOMAIN, 'ImageManagement', 'è¯»å–é•œåƒä¿¡æ¯å¤±è´¥: %{public}s', JSON.stringify(e))
      this.errorMessage = getContext(this).resourceManager.getStringSync($r('app.string.msg_read_image_info_fail').id)
    }
  }

  /**
   * åŒæ­¥ç‰ˆæœ¬ï¼ˆç”¨äºåˆ·æ–°æ—¶è°ƒç”¨ï¼Œä¿æŒå‘åå…¼å®¹ï¼‰
   */
  private loadBasicInfo(): void {
    this.loadBasicInfoAsync()
  }

  /**
   * å¼‚æ­¥è¯»å– QCOW2 æ–‡ä»¶çš„è™šæ‹Ÿå¤§å°
   */
  private async readQcow2VirtualSizeAsync(filePath: string): Promise<number> {
    try {
      const f = await fs.open(filePath, fs.OpenMode.READ_ONLY)
      const HEADER_SIZE = 32
      const buffer = new ArrayBuffer(HEADER_SIZE)
      const readResult = await fs.read(f.fd, buffer, { offset: 0, length: HEADER_SIZE })
      await fs.close(f)
      
      if (readResult < HEADER_SIZE) {
        return 0
      }
      
      const dataView = new DataView(buffer)
      const size = dataView.getBigInt64(24, false)
      return Number(size)
    } catch (e) {
      return 0
    }
  }

  /**
   * åŠ è½½è¯¦ç»†é•œåƒä¿¡æ¯ï¼ˆä½¿ç”¨ taskpool å¼‚æ­¥è°ƒç”¨ NAPIï¼‰
   */
  private async loadDetailInfo(): Promise<void> {
    if (!this.checkPC()) return
    if (!this.basicInfo) return
    
    this.isLoading = true
    this.errorMessage = ''
    
    try {
      // ä½¿ç”¨ taskpool å¼‚æ­¥è°ƒç”¨ NAPI è·å–è¯¦ç»†ä¿¡æ¯
      const jsonOutput = await taskpool.execute(getImageInfoTask, this.basicInfo.path) as string
      
      hilog.info(DOMAIN, 'ImageManagement', 'qemu-img info è¾“å‡º: %{public}s', jsonOutput)
      
      // è§£æ JSON è¾“å‡º
      const info = JSON.parse(jsonOutput) as Record<string, Object>
      
      // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
      if (info['error']) {
        this.errorMessage = info['error'] as string
        return
      }
      
      // æå–è¯¦ç»†ä¿¡æ¯
      const formatSpecific = info['format-specific'] as Record<string, Object> | undefined
      const qcow2Data = formatSpecific?.['data'] as Record<string, Object> | undefined
      
      this.detailInfo = {
        image: info['filename'] as string || this.basicInfo.path,
        fileFormat: info['format'] as string || 'unknown',
        virtualSize: info['virtual-size'] as number || this.basicInfo.virtualSize,
        diskSize: info['actual-size'] as number || this.basicInfo.diskSize,
        clusterSize: info['cluster-size'] as number,
        lazyRefcounts: qcow2Data?.['lazy-refcounts'] as boolean,
        extendedL2: qcow2Data?.['extended-l2'] as boolean,
        compressionType: qcow2Data?.['compression-type'] as string,
        compat: qcow2Data?.['compat'] as string,
        refcountBits: qcow2Data?.['refcount-bits'] as number,
        corrupt: qcow2Data?.['corrupt'] as boolean
      }
      
      // æ‰“å¼€è¯¦æƒ…å¯¹è¯æ¡†
      this.detailDialogController.open()
    } catch (e) {
      hilog.error(DOMAIN, 'ImageManagement', 'è·å–é•œåƒè¯¦æƒ…å¤±è´¥: %{public}s', JSON.stringify(e))
      this.errorMessage = getContext(this).resourceManager.getStringSync($r('app.string.msg_get_detail_fail').id) + (e as Error).message
    } finally {
      this.isLoading = false
    }
  }


  /**
   * æ ¼å¼åŒ–å¤§å°æ˜¾ç¤º
   */
  private formatSize(bytes: number): string {
    if (bytes === 0) return '0 B'
    
    const units = ['B', 'KB', 'MB', 'GB', 'TB']
    const k = 1024
    const i = Math.floor(Math.log(bytes) / Math.log(k))
    const size = bytes / Math.pow(k, i)
    
    return `${size.toFixed(2)} ${units[i]}`
  }

  /**
   * å¤åˆ¶è·¯å¾„åˆ°å‰ªè´´æ¿ï¼ˆå¤åˆ¶ç”¨æˆ·ä¾§è·¯å¾„ï¼‰
   */
  private async copyPath(): Promise<void> {
    if (!this.basicInfo) return
    
    try {
      const board = pasteboard.getSystemPasteboard()
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, this.basicInfo.userPath)
      await board.setData(pasteData)
      
      this.promptAction.showToast({
        message: $r('app.string.msg_path_copied'),
        duration: 2000
      })
    } catch (e) {
      hilog.error(DOMAIN, 'ImageManagement', 'å¤åˆ¶è·¯å¾„å¤±è´¥: %{public}s', JSON.stringify(e))
    }
  }

  // ================== ä»»åŠ¡é”è¾…åŠ©æ–¹æ³• ==================

  /**
   * å°è¯•è·å–ä»»åŠ¡é”
   * @param description ä»»åŠ¡æè¿°
   * @returns æ˜¯å¦æˆåŠŸè·å–é”
   */
  private checkAndLockTask(description: string): boolean {
    if (this.globalTaskRunning) {
      this.promptAction.showToast({
        message: getContext(this).resourceManager.getStringSync($r('app.string.msg_bg_task_running').id) + this.globalTaskDescription,
        duration: 2000
      })
      return false
    }
    this.globalTaskRunning = true
    this.globalTaskDescription = description
    return true
  }

  /**
   * é‡Šæ”¾ä»»åŠ¡é”
   */
  private unlockTask(): void {
    this.globalTaskRunning = false
    this.globalTaskDescription = ''
  }

  // ================== å¿«ç…§ç®¡ç†æ–¹æ³• ==================

  /**
   * å¼‚æ­¥åŠ è½½å¿«ç…§åˆ—è¡¨ï¼ˆä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
   */
  private async loadSnapshotsAsync(): Promise<void> {
    if (!this.basicInfo) return
    
    this.isSnapshotLoading = true
    this.snapshotError = ''
    
    try {
      // ä½¿ç”¨ taskpool å¼‚æ­¥è°ƒç”¨
      const jsonOutput = await taskpool.execute(getSnapshotsTask, this.basicInfo.path) as string
      hilog.info(DOMAIN, 'ImageManagement', 'å¿«ç…§åˆ—è¡¨: %{public}s', jsonOutput)
      
      const result = JSON.parse(jsonOutput) as Record<string, Object>
      
      if (result['error']) {
        this.snapshotError = result['error'] as string
        return
      }
      
      this.snapshots = (result['snapshots'] as SnapshotInfo[]) || []
      this.needRestart = await taskpool.execute(needRestartTask) as boolean
    } catch (e) {
      hilog.error(DOMAIN, 'ImageManagement', 'åŠ è½½å¿«ç…§å¤±è´¥: %{public}s', JSON.stringify(e))
      this.snapshotError = getContext(this).resourceManager.getStringSync($r('app.string.msg_load_snapshot_failed').id)
    } finally {
      this.isSnapshotLoading = false
    }
  }

  /**
   * åŒæ­¥ç‰ˆæœ¬ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
   */
  private loadSnapshots(): void {
    this.loadSnapshotsAsync()
  }

  /**
   * æ£€æŸ¥æ˜¯å¦éœ€è¦å…³æœºï¼ˆæ“ä½œå‰æ£€æŸ¥ï¼‰
   * @returns true å¦‚æœéœ€è¦å…³æœºä½† VM æ­£åœ¨è¿è¡Œ
   */
  private checkNeedShutdown(): boolean {
    if (this.isVmRunning) {
      this.promptAction.showToast({
        message: $r('app.string.vm_shutdown_required'),
        duration: 3000
      })
      return true
    }
    return false
  }

  /**
   * æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å¯åº”ç”¨
   */
  private checkNeedRestart(): boolean {
    if (this.needRestart) {
      this.promptAction.showToast({
        message: $r('app.string.restart_app_required'),
        duration: 3000
      })
      return true
    }
    return false
  }

  /**
   * åˆ›å»ºå¿«ç…§
   */
  private async createSnapshot(name: string): Promise<void> {
    const basicInfo = this.basicInfo
    if (!basicInfo) return
    if (!this.checkAndLockTask(getContext(this).resourceManager.getStringSync($r('app.string.task_creating_snapshot').id))) return
    
    this.isLoading = true
    try {
      hilog.info(DOMAIN, 'ImageManagement', 'createSnapshot: path=%{public}s, name=%{public}s', basicInfo.path, name)
      
      const result = await taskpool.execute(createSnapshotTask, basicInfo.path, name) as string
      const response = JSON.parse(result) as Record<string, Object>
      
      if (response['error']) {
        this.errorMessage = response['error'] as string
        if (response['need_restart']) {
          this.needRestart = true
        }
      } else {
        this.promptAction.showToast({
          message: $r('app.string.msg_snapshot_created'),
          duration: 2000
        })
        await this.loadSnapshots()
      }
    } catch (e) {
      hilog.error(DOMAIN, 'ImageManagement', 'åˆ›å»ºå¿«ç…§å¤±è´¥: %{public}s', JSON.stringify(e))
      this.errorMessage = getContext(this).resourceManager.getStringSync($r('app.string.msg_snapshot_create_fail').id) + (e as Error).message
    } finally {
      this.isLoading = false
    }
  }

  /**
   * æ¢å¤å¿«ç…§
   */
  private async applySnapshot(name: string): Promise<void> {
    const basicInfo = this.basicInfo
    if (!basicInfo) return
    if (this.checkNeedShutdown()) return
    if (this.checkNeedRestart()) return
    if (!this.checkAndLockTask(getContext(this).resourceManager.getStringSync($r('app.string.task_restoring_snapshot').id))) return
    
    this.promptAction.showDialog({
      title: $r('app.string.dialog_confirm_restore'),
      message: getContext(this).resourceManager.getStringSync($r('app.string.msg_confirm_restore').id) + ` "${name}" ` + getContext(this).resourceManager.getStringSync($r('app.string.msg_confirm_restore_suffix').id),
      buttons: [
        { text: $r('app.string.setting_generic_cancel'), color: '#666666' },
        { text: $r('app.string.btn_restore'), color: '#E74C3C' }
      ]
    }).then(async (result) => {
      if (result.index === 1) {
        this.isLoading = true
        try {
          hilog.info(DOMAIN, 'ImageManagement', 'applySnapshot: path=%{public}s, name=%{public}s', basicInfo.path, name)
          
          const result = await taskpool.execute(applySnapshotTask, basicInfo.path, name) as string
          const response = JSON.parse(result) as Record<string, Object>
          
          if (response['error']) {
            this.errorMessage = response['error'] as string
            if (response['need_restart']) {
              this.needRestart = true
            }
          } else {
            this.promptAction.showToast({
              message: $r('app.string.msg_snapshot_restored'),
              duration: 2000
            })
          }
        } catch (e) {
          hilog.error(DOMAIN, 'ImageManagement', 'æ¢å¤å¿«ç…§å¤±è´¥: %{public}s', JSON.stringify(e))
          this.errorMessage = getContext(this).resourceManager.getStringSync($r('app.string.msg_snapshot_restore_fail').id) + (e as Error).message
        } finally {
          this.isLoading = false
          this.unlockTask()
        }
      } else {
        this.unlockTask()
      }
    })
  }

  /**
   * åˆ é™¤å¿«ç…§
   */
  private async deleteSnapshot(name: string): Promise<void> {
    const basicInfo = this.basicInfo
    if (!basicInfo) return
    if (this.checkNeedShutdown()) return
    if (this.checkNeedRestart()) return
    if (!this.checkAndLockTask(getContext(this).resourceManager.getStringSync($r('app.string.task_deleting_snapshot').id))) return
    
    this.promptAction.showDialog({
      title: $r('app.string.dialog_confirm_delete'),
      message: getContext(this).resourceManager.getStringSync($r('app.string.msg_confirm_delete_snapshot').id) + ` "${name}"?`,
      buttons: [
        { text: $r('app.string.setting_generic_cancel'), color: '#666666' },
        { text: $r('app.string.delete_this'), color: '#E74C3C' }
      ]
    }).then(async (result) => {
      if (result.index === 1) {
        this.isLoading = true
        try {
          hilog.info(DOMAIN, 'ImageManagement', 'deleteSnapshot: path=%{public}s, name=%{public}s', basicInfo.path, name)
          
          const result = await taskpool.execute(deleteSnapshotTask, basicInfo.path, name) as string
          const response = JSON.parse(result) as Record<string, Object>
          
          if (response['error']) {
            this.errorMessage = response['error'] as string
            if (response['need_restart']) {
              this.needRestart = true
            }
          } else {
            this.promptAction.showToast({
              message: $r('app.string.msg_snapshot_deleted'),
              duration: 2000
            })
            await this.loadSnapshots()
          }
        } catch (e) {
          hilog.error(DOMAIN, 'ImageManagement', 'åˆ é™¤å¿«ç…§å¤±è´¥: %{public}s', JSON.stringify(e))
          this.errorMessage = getContext(this).resourceManager.getStringSync($r('app.string.msg_snapshot_delete_fail').id) + (e as Error).message
        } finally {
          this.isLoading = false
          this.unlockTask()
        }
      } else {
        this.unlockTask()
      }
    })
  }

  /**
   * æ‰¹é‡åˆ é™¤å¿«ç…§
   */
  private async batchDeleteSnapshots(): Promise<void> {
    const basicInfo = this.basicInfo
    if (!basicInfo || this.selectedSnapshots.size === 0) return
    if (this.checkNeedShutdown()) return
    if (this.checkNeedRestart()) return
    if (!this.checkAndLockTask(getContext(this).resourceManager.getStringSync($r('app.string.task_batch_deleting_snapshots').id))) return

    this.promptAction.showDialog({
      title: $r('app.string.dialog_confirm_batch_delete'),
      message: getContext(this).resourceManager.getStringSync($r('app.string.msg_confirm_batch_delete').id) + ` ${this.selectedSnapshots.size} ` + getContext(this).resourceManager.getStringSync($r('app.string.msg_confirm_batch_delete_suffix').id),
      buttons: [
        { text: $r('app.string.setting_generic_cancel'), color: '#666666' },
        { text: $r('app.string.delete_this'), color: '#E74C3C' }
      ]
    }).then(async (result) => {
      if (result.index === 1) {
        this.isLoading = true
        let successCount = 0
        let failCount = 0
        
        try {
          // è½¬æ¢ä¸ºæ•°ç»„ä»¥è¿›è¡Œè¿­ä»£
          const snapshotsToDelete = Array.from(this.selectedSnapshots)
          
          for (const id of snapshotsToDelete) {
            // æ ¹æ®IDæŸ¥æ‰¾åç§°
            const snapshot = this.snapshots.find(s => s.id === id)
            if (!snapshot) continue
            
            try {
              const result = await taskpool.execute(deleteSnapshotTask, basicInfo.path, snapshot.name) as string
              const response = JSON.parse(result) as Record<string, Object>
              
              if (response['error']) {
                failCount++
                hilog.error(DOMAIN, 'ImageManagement', 'åˆ é™¤å¿«ç…§ %{public}s å¤±è´¥: %{public}s', snapshot.name, response['error'])
              } else {
                successCount++
              }
            } catch (e) {
              failCount++
              hilog.error(DOMAIN, 'ImageManagement', 'åˆ é™¤å¿«ç…§ %{public}s å¼‚å¸¸: %{public}s', snapshot.name, JSON.stringify(e))
            }
          }
          
          this.promptAction.showToast({
            message: getContext(this).resourceManager.getStringSync($r('app.string.msg_batch_delete_result').id) + ` ${successCount}, ` + getContext(this).resourceManager.getStringSync($r('app.string.msg_failed').id) + ` ${failCount}`,
            duration: 3000
          })
          
          this.selectedSnapshots.clear()
          await this.loadSnapshots()
          
        } catch (e) {
          this.errorMessage = getContext(this).resourceManager.getStringSync($r('app.string.msg_batch_delete_fail').id) + (e as Error).message
        } finally {
          this.isLoading = false
          this.unlockTask()
        }
      } else {
        this.unlockTask()
      }
    })
  }

  /**
   * ä¼˜åŒ–é•œåƒ
   * @param mode 'sparse' | 'prealloc' | 'cleanup' | 'optimize'
   */
  private async optimizeImage(mode: 'sparse' | 'prealloc' | 'cleanup' | 'optimize'): Promise<void> {
    const basicInfo = this.basicInfo
    if (!basicInfo) return
    if (this.checkNeedShutdown()) return
    if (this.checkNeedRestart()) return
    
    const modeNames: Record<string, Resource> = {
      'sparse': $r('app.string.optimize_mode_sparse'),
      'prealloc': $r('app.string.optimize_mode_prealloc'),
      'optimize': $r('app.string.optimize_mode_optimize')
    }
    const tempPath = `${basicInfo.path}.tmp`
    
    // æ£€æŸ¥å…¨å±€ä»»åŠ¡çŠ¶æ€
    if (this.globalTaskRunning) {
      this.promptAction.showDialog({
        title: $r('app.string.dialog_task_running'),
        message: getContext(this).resourceManager.getStringSync($r('app.string.msg_task_running_prefix').id) + `${this.globalTaskDescription}\n\n` + getContext(this).resourceManager.getStringSync($r('app.string.msg_task_running_desc').id),
        buttons: [
          { text: $r('app.string.btn_wait'), color: '#007DFF' },
          { text: $r('app.string.btn_force_cleanup'), color: '#E74C3C' }
        ]
      }).then(async (result) => {
        if (result.index === 1) {
          // å¼ºåˆ¶æ¸…ç†
          this.unlockTask()
          try {
            await fs.unlink(tempPath)
          } catch (e) {
            // å¿½ç•¥
          }
          this.promptAction.showToast({
            message: $r('app.string.msg_task_cleaned'),
            duration: 2000
          })
        }
      })
      return
    }

    
    // é˜²æ­¢é‡å¤æ“ä½œ
    if (this.isLoading) {
      this.promptAction.showToast({
        message: $r('app.string.msg_op_in_progress'),
        duration: 2000
      })
      return
    }
    
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸´æ—¶æ–‡ä»¶ï¼ˆä¸Šæ¬¡æ“ä½œå¯èƒ½æœªå®Œæˆæˆ–ä¸­æ–­ï¼‰
    try {
      await fs.access(tempPath)
      // ä¸´æ—¶æ–‡ä»¶å­˜åœ¨ï¼Œè¯¢é—®ç”¨æˆ·å¦‚ä½•å¤„ç†
      const tmpStat = await fs.stat(tempPath)
      const tmpSize = this.formatSize(tmpStat.size)
      const modTime = new Date(tmpStat.mtime)
      const elapsed = Math.round((Date.now() - modTime.getTime()) / 1000 / 60)  // åˆ†é’Ÿ
      
      this.promptAction.showDialog({
        title: $r('app.string.dialog_temp_file_found'),
        message: getContext(this).resourceManager.getStringSync($r('app.string.msg_temp_file_found').id) + ` (${tmpSize})ï¼Œ` + getContext(this).resourceManager.getStringSync($r('app.string.msg_temp_file_time').id) + ` ${elapsed} ` + getContext(this).resourceManager.getStringSync($r('app.string.msg_temp_file_desc').id),
        buttons: [
          { text: $r('app.string.setting_generic_cancel'), color: '#666666' },
          { text: $r('app.string.btn_force_cleanup'), color: '#E74C3C' }
        ]
      }).then(async (result) => {
        if (result.index === 1) {
          try {
            await fs.unlink(tempPath)
            this.globalTaskRunning = false
            this.globalTaskDescription = ''
            this.promptAction.showToast({
              message: $r('app.string.msg_temp_file_cleaned'),
              duration: 2000
            })
          } catch (e) {
            this.errorMessage = getContext(this).resourceManager.getStringSync($r('app.string.msg_temp_file_clean_fail').id) + (e as Error).message
          }
        }
      })
      return
    } catch (e) {
      // ä¸´æ—¶æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯ä»¥ç»§ç»­
    }
    
    // è®¾ç½®ä»»åŠ¡çŠ¶æ€
    this.isLoading = true
    const modeName = getContext(this).resourceManager.getStringSync(modeNames[mode].id)
    this.checkAndLockTask(`${modeName} (${new Date().toLocaleTimeString()})`)
    
    // æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†ï¼ˆä¸å¯å…³é—­ï¼‰
    this.optimizeTaskMessage = getContext(this).resourceManager.getStringSync($r('app.string.msg_executing_prefix').id) + `${modeName}` + getContext(this).resourceManager.getStringSync($r('app.string.msg_executing_suffix').id)
    this.optimizeProgressDialog.open()
    
    try {
      hilog.info(DOMAIN, 'ImageManagement', 'å¼€å§‹ä¼˜åŒ–é•œåƒ: mode=%{public}s, output=%{public}s', mode, tempPath)
      
      // ä½¿ç”¨ taskpool æ‰§è¡Œè€—æ—¶æ“ä½œ
      const result = await taskpool.execute(optimizeImageTask, basicInfo.path, tempPath, mode) as string
      const response = JSON.parse(result) as Record<string, Object>
      
      if (response['error']) {
        this.errorMessage = response['error'] as string
        if (response['need_restart']) {
          this.needRestart = true
        }
        // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
        try {
          await fs.unlink(tempPath)
        } catch (e) {
          // å¿½ç•¥åˆ é™¤å¤±è´¥
        }
        return
      }
      
      // è·å–ä¼˜åŒ–å‰åå¤§å°
      const oldSize = basicInfo.diskSize
      const newStat = await fs.stat(tempPath)
      const newSize = newStat.size
      
      // æ›¿æ¢åŸæ–‡ä»¶
      try {
        await fs.unlink(basicInfo.path)
        await fs.rename(tempPath, basicInfo.path)
      } catch (e) {
        this.errorMessage = getContext(this).resourceManager.getStringSync($r('app.string.msg_replace_file_fail').id) + (e as Error).message
        return
      }
      
      // è®¡ç®—èŠ‚çœç©ºé—´
      const savedBytes = oldSize - newSize
      const savedStr = savedBytes > 0 ? getContext(this).resourceManager.getStringSync($r('app.string.msg_saved_space').id) + ` ${this.formatSize(savedBytes)}` : getContext(this).resourceManager.getStringSync($r('app.string.msg_increased_space').id) + ` ${this.formatSize(-savedBytes)}`
      
      this.promptAction.showToast({
        message: getContext(this).resourceManager.getStringSync($r('app.string.msg_optimize_finished').id) + `${savedStr}`,
        duration: 3000
      })
      
      // åˆ·æ–°åŸºç¡€ä¿¡æ¯
      this.loadBasicInfo()
    } catch (e) {
      hilog.error(DOMAIN, 'ImageManagement', 'ä¼˜åŒ–é•œåƒå¤±è´¥: %{public}s', JSON.stringify(e))
      this.errorMessage = getContext(this).resourceManager.getStringSync($r('app.string.msg_optimize_fail').id) + (e as Error).message
    } finally {
      this.optimizeProgressDialog.close()
      this.isLoading = false
      this.unlockTask()
    }
  }

  /**
   * å¼ºåˆ¶æ¸…ç†åå°ä»»åŠ¡çŠ¶æ€
   */
  private async forceCleanupTask(): Promise<void> {
    const basicInfo = this.basicInfo
    if (!basicInfo) return
    
    this.promptAction.showDialog({
      title: $r('app.string.dialog_confirm_force_cleanup'),
      message: $r('app.string.msg_confirm_force_cleanup'),
      buttons: [
        { text: $r('app.string.setting_generic_cancel'), color: '#666666' },
        { text: $r('app.string.btn_force_cleanup'), color: '#E74C3C' }
      ]
    }).then(async (result) => {
      if (result.index === 1) {
        const tempPath = `${basicInfo.path}.tmp`
        try {
          await fs.unlink(tempPath)
        } catch (e) {
          // å¿½ç•¥
        }
        this.optimizeProgressDialog.close()
        this.isLoading = false
        this.unlockTask()
        this.promptAction.showToast({
          message: $r('app.string.msg_task_state_cleaned'),
          duration: 2000
        })
      }
    })
  }

  /**
   * æ˜¾ç¤ºä¼˜åŒ–å¯¹è¯æ¡†
   */
  private showOptimizeDialog(): void {
    if (!this.checkPC()) return
    if (this.checkNeedShutdown()) return
    if (this.checkNeedRestart()) return
    
    this.optimizeModeDialogController.open()
  }
  
  @Builder
  buildOptimizeModeContent() {
    Column({ space: 8 }) {
      // æ ¼å¼ä¼˜åŒ–æŒ‰é’® - ç»¿è‰²æ¨è
      Button({ type: ButtonType.Normal, stateEffect: true }) {
        Row({ space: 8 }) {
          Text('ğŸš€')
            .fontSize(18)
          Column() {
            Text($r('app.string.optimize_mode_optimize'))
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#FFFFFF')
            Text($r('app.string.desc_optimize'))
              .fontSize(10)
              .fontColor('#FFFFFF')
              .opacity(0.8)
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .padding({ left: 12, right: 12 })
      }
      .width('100%')
      .height(52)
      .backgroundColor('#2ECC71')
      .borderRadius(8)
      .onClick(() => {
        this.optimizeModeDialogController.close()
        this.confirmAndOptimize('optimize', $r('app.string.optimize_mode_optimize'), $r('app.string.msg_optimize_confirm'))
      })
      
      // æ•´ç†ç¢ç‰‡æŒ‰é’® - è“è‰²
      Button({ type: ButtonType.Normal, stateEffect: true }) {
        Row({ space: 8 }) {
          Text('ğŸ§¹')
            .fontSize(18)
          Column() {
            Text($r('app.string.optimize_mode_sparse'))
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#FFFFFF')
            Text($r('app.string.desc_sparse'))
              .fontSize(10)
              .fontColor('#FFFFFF')
              .opacity(0.8)
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .padding({ left: 12, right: 12 })
      }
      .width('100%')
      .height(52)
      .backgroundColor('#3498DB')
      .borderRadius(8)
      .onClick(() => {
        this.optimizeModeDialogController.close()
        this.optimizeImage('sparse')
      })
      
      // é¢„åˆ†é…æ ¼å¼æŒ‰é’® - æ©™è‰²è­¦å‘Š
      Button({ type: ButtonType.Normal, stateEffect: true }) {
        Row({ space: 8 }) {
          Text('âš¡')
            .fontSize(18)
          Column() {
            Text($r('app.string.title_prealloc'))
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#FFFFFF')
            Text($r('app.string.desc_prealloc'))
              .fontSize(10)
              .fontColor('#FFFFFF')
              .opacity(0.8)
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .padding({ left: 12, right: 12 })
      }
      .width('100%')
      .height(52)
      .backgroundColor('#E67E22')
      .borderRadius(8)
      .onClick(() => {
        this.optimizeModeDialogController.close()
        this.confirmAndOptimize('prealloc', $r('app.string.title_prealloc'), $r('app.string.msg_prealloc_confirm'))
      })
    }
    .padding(8)
    .width('100%')
  }
  
  /**
   * ç¡®è®¤åæ‰§è¡Œä¼˜åŒ–
   */
  private confirmAndOptimize(mode: 'sparse' | 'prealloc' | 'cleanup' | 'optimize', title: Resource, message: Resource): void {
    this.promptAction.showDialog({
      title: title,
      message: message,
      buttons: [
        { text: $r('app.string.setting_generic_cancel'), color: '#666666' },
        { text: $r('app.string.btn_start'), color: '#007DFF' }
      ]
    }).then((result) => {
      if (result.index === 1) {
        this.optimizeImage(mode)
      }
    })
  }

  build() {
    Scroll() {
      Column() {
        if (this.errorMessage) {
          // é”™è¯¯æç¤º
          Row() {
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor('#E74C3C')
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFF0F0')
          .borderRadius(8)
          .margin({ bottom: 16 })
        }

        if (this.basicInfo) {
          // åŸºç¡€ä¿¡æ¯åŒºåŸŸ
          Column() {
            Text($r('app.string.title_basic_info'))
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 12 })
              .alignSelf(ItemAlign.Start)

            // é•œåƒåç§°
            Row() {
              Text($r('app.string.image_name'))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                .width(80)
              Text(this.basicInfo.name)
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_primary'))
                .layoutWeight(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .maxLines(1)
            }
            .width('100%')
            .padding({ top: 8, bottom: 8 })

            Divider().color($r('sys.color.ohos_id_color_list_separator'))

            // ç³»ç»Ÿè·¯å¾„ï¼ˆç¨‹åºä½¿ç”¨ï¼‰
            Row() {
              Text($r('app.string.label_system_path'))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                .width(80)
              Text(this.basicInfo.path)
                .fontSize(9)
                .fontColor($r('sys.color.ohos_id_color_text_tertiary'))
                .layoutWeight(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .maxLines(2)
            }
            .width('100%')
            .padding({ top: 8, bottom: 8 })

            Divider().color($r('sys.color.ohos_id_color_list_separator'))

            // ç”¨æˆ·è·¯å¾„ï¼ˆç”¨æˆ·å¯è®¿é—®ï¼‰
            Row() {
              Text($r('app.string.label_file_path'))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                .width(80)
              Text(this.basicInfo.userPath)
                .fontSize(9)
                .fontColor($r('sys.color.ohos_id_color_text_primary'))
                .layoutWeight(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .maxLines(2)
              Button($r('app.string.copy_this'), { buttonStyle: ButtonStyleMode.TEXTUAL, controlSize: ControlSize.SMALL })
                .fontSize(10)
                .onClick(() => this.copyPath())
            }
            .width('100%')
            .padding({ top: 8, bottom: 8 })

            Divider().color($r('sys.color.ohos_id_color_list_separator'))

            // è™šæ‹Ÿå¤§å°
            Row() {
              Text($r('app.string.virtual_size'))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                .width(80)
              Text(this.formatSize(this.basicInfo.virtualSize))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_primary'))
                .layoutWeight(1)
            }
            .width('100%')
            .padding({ top: 8, bottom: 8 })

            Divider().color($r('sys.color.ohos_id_color_list_separator'))

            // å®é™…å ç”¨
            Row() {
              Text($r('app.string.disk_size'))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                .width(80)
              Text(this.formatSize(this.basicInfo.diskSize))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_primary'))
                .layoutWeight(1)
            }
            .width('100%')
            .padding({ top: 8, bottom: 8 })

            // ç©ºé—´åˆ©ç”¨ç‡
            Row() {
              Text($r('app.string.space_usage'))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                .width(80)
              Text(`${((this.basicInfo.diskSize / this.basicInfo.virtualSize) * 100).toFixed(1)}%`)
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_primary'))
                .layoutWeight(1)
            }
            .width('100%')
            .padding({ top: 8, bottom: 8 })
          }
          .width('100%')
          .padding(16)
          .backgroundColor($r('sys.color.ohos_id_color_sub_background'))
          .borderRadius(8)
          .margin({ bottom: 16 })
          // æ“ä½œæŒ‰é’®è¡Œ
          Row() {
            // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
            Button($r('app.string.view_details'), { buttonStyle: ButtonStyleMode.TEXTUAL })
              .layoutWeight(1)
              .height(36)
              .enabled(!this.isLoading && !this.globalTaskRunning)
              .onClick(() => this.loadDetailInfo())

            // ä¼˜åŒ–é•œåƒæŒ‰é’®
            Button($r('app.string.optimize_image'))
              .layoutWeight(1)
              .height(36)
              .backgroundColor('#007DFF')
              .fontColor(Color.White)
              .enabled(!this.isLoading && !this.isVmRunning && !this.needRestart && !this.globalTaskRunning)
              .onClick(() => this.showOptimizeDialog())
          }
          .width('100%')
          
          // VM è¿è¡Œä¸­æç¤º
          if (this.isVmRunning) {
            Row() {
              SymbolGlyph($r('sys.symbol.info_circle'))
                .fontSize(14)
                .fontColor(['#E67E22'])
              Text($r('app.string.msg_vm_running_optimize'))
                .fontSize(11)
                .fontColor('#E67E22')
                .margin({ left: 6 })
            }
            .width('100%')
            .margin({ top: 8 })
            .padding(8)
            .backgroundColor('#FFF8E7')
            .borderRadius(6)
          }
          
          // éœ€è¦é‡å¯æç¤º
          if (this.needRestart) {
            Row() {
              SymbolGlyph($r('sys.symbol.exclamationmark_triangle'))
                .fontSize(14)
                .fontColor(['#E74C3C'])
              Text($r('app.string.msg_image_modified'))
                .fontSize(11)
                .fontColor('#E74C3C')
                .margin({ left: 6 })
            }
            .width('100%')
            .margin({ top: 8 })
            .padding(8)
            .backgroundColor('#FFF0F0')
            .borderRadius(6)
          }
          
          // åå°ä»»åŠ¡çŠ¶æ€æç¤ºå’Œå¼ºåˆ¶æ¸…ç†æŒ‰é’®
          if (this.globalTaskRunning) {
            Row() {
              LoadingProgress()
                .width(20)
                .height(20)
              Text(getContext(this).resourceManager.getStringSync($r('app.string.label_bg_task').id) + `${this.globalTaskDescription}`)
                .fontSize(12)
                .fontColor('#007DFF')
                .margin({ left: 8 })
                .layoutWeight(1)
              Button($r('app.string.btn_force_cleanup'), { buttonStyle: ButtonStyleMode.TEXTUAL })
                .fontSize(12)
                .fontColor('#E74C3C')
                .onClick(() => this.forceCleanupTask())
            }
            .width('100%')
            .margin({ top: 12 })
            .padding(8)
            .backgroundColor('#FFF3CD')
            .borderRadius(8)
          }

          if (this.isLoading && !this.globalTaskRunning) {
            Row() {
              LoadingProgress()
                .width(24)
                .height(24)
              Text($r('app.string.msg_getting_details'))
                .fontSize(12)
                .margin({ left: 8 })
            }
            .margin({ top: 16 })
          }
        } else {
          // åŠ è½½ä¸­çŠ¶æ€
          Row() {
            LoadingProgress()
              .width(24)
              .height(24)
            Text($r('app.string.msg_loading_image_info'))
              .fontSize(12)
              .margin({ left: 8 })
          }
          .padding(16)
        }

        // è¯´æ˜æ–‡å­—
        Text($r('app.string.msg_image_size_hint'))
          .fontSize(11)
          .fontColor($r('sys.color.ohos_id_color_text_secondary'))
          .margin({ top: 16 })
          .width('100%')

        // ================== å¿«ç…§ç®¡ç†åŒºåŸŸ ==================
        Column() {
          // æ ‡é¢˜è¡Œ
          Row() {
            Text($r('app.string.snapshot_management'))
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .layoutWeight(1)
            
            // åˆ·æ–°æŒ‰é’®
            Button({ type: ButtonType.Circle, stateEffect: true }) {
              SymbolGlyph($r('sys.symbol.arrow_clockwise'))
                .fontSize(16)
                .fontColor([$r('sys.color.ohos_id_color_text_primary')])
            }
            .width(24)
            .height(24)
            .backgroundColor(Color.Transparent)
            .onClick(() => this.loadSnapshots())
          }
          .width('100%')
          .margin({ bottom: 8 })

          if (this.isSnapshotLoading) {
            Row() {
              LoadingProgress()
                .width(20)
                .height(20)
              Text($r('app.string.msg_loading_snapshots'))
                .fontSize(12)
                .margin({ left: 8 })
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .padding(16)
          } else if (this.snapshotError) {
            Text(this.snapshotError)
              .fontSize(12)
              .fontColor('#E74C3C')
              .padding(16)
          } else if (this.snapshots.length === 0) {
            Text($r('app.string.msg_no_snapshots'))
              .fontSize(12)
              .fontColor($r('sys.color.ohos_id_color_text_tertiary'))
              .width('100%')
              .textAlign(TextAlign.Center)
              .padding(16)
              .backgroundColor($r('sys.color.ohos_id_color_sub_background'))
              .borderRadius(8)
              .margin({ top: 8, bottom: 8 })
          } else {
            // å¿«ç…§åˆ—è¡¨è¡¨æ ¼
            Column() {
              // å…¨é€‰æ§åˆ¶è¡Œ
              Row() {
                Checkbox()
                  .select(this.snapshots.length > 0 && this.selectedSnapshots.size === this.snapshots.length)
                  .onChange((selected: boolean) => {
                    // ä½¿ç”¨ setTimeout é¿å…åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­æ›´æ–°çŠ¶æ€
                    setTimeout(() => {
                      if (selected) {
                        this.snapshots.forEach(s => this.selectedSnapshots.add(s.id))
                      } else {
                        this.selectedSnapshots.clear()
                      }
                      this.selectedSnapshots = new Set(this.selectedSnapshots)
                    }, 0)
                  })
                  .width(20)
                  .height(20)
                
                Text($r('app.string.btn_select_all'))
                  .fontSize(12)
                  .margin({ left: 8 })
                  .fontWeight(FontWeight.Bold)
              }
              .width('100%')
              .padding({ top: 4, bottom: 4 })
              
              Divider().color($r('sys.color.ohos_id_color_list_separator'))

              ForEach(this.snapshots, (snapshot: SnapshotInfo) => {
                Row() {
                  // å‹¾é€‰æ¡†
                  Checkbox()
                    .select(this.selectedSnapshots.has(snapshot.id))
                    .onChange((selected: boolean) => {
                      // ä½¿ç”¨ setTimeout é¿å…åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­æ›´æ–°çŠ¶æ€
                      setTimeout(() => {
                        if (selected) {
                          this.selectedSnapshots.add(snapshot.id)
                        } else {
                          this.selectedSnapshots.delete(snapshot.id)
                        }
                        this.selectedSnapshots = new Set(this.selectedSnapshots)
                      }, 0)
                    })
                    .width(20)
                    .height(20)
                  
                  // å¿«ç…§åç§°
                  Text(snapshot.name)
                    .fontSize(12)
                    .layoutWeight(1)
                    .margin({ left: 8 })
                  
                  // åˆ›å»ºæ—¥æœŸ
                  Text(snapshot.date.substring(5, 16))
                    .fontSize(10)
                    .fontColor($r('sys.color.ohos_id_color_text_tertiary'))
                    .width(80)
                  
                  // æ¢å¤æŒ‰é’®
                  Button($r('app.string.btn_restore'), { buttonStyle: ButtonStyleMode.TEXTUAL, controlSize: ControlSize.SMALL })
                    .fontSize(10)
                    .onClick(() => this.applySnapshot(snapshot.name))
                    .enabled(!this.isVmRunning && !this.needRestart && !this.globalTaskRunning)
                  
                  // åˆ é™¤æŒ‰é’®
                  Button($r('app.string.delete_this'), { buttonStyle: ButtonStyleMode.TEXTUAL, controlSize: ControlSize.SMALL })
                    .fontSize(10)
                    .fontColor('#E74C3C')
                    .onClick(() => this.deleteSnapshot(snapshot.name))
                    .enabled(!this.isVmRunning && !this.needRestart && !this.globalTaskRunning)
                }
                .width('100%')
                .padding({ top: 8, bottom: 8 })
                
                Divider().color($r('sys.color.ohos_id_color_list_separator'))
              })
            }
            .width('100%')
            .padding(12)
            .backgroundColor($r('sys.color.ohos_id_color_sub_background'))
            .borderRadius(8)
            .margin({ top: 8, bottom: 8 })
          }

          // åº•éƒ¨æ“ä½œæ 
          Row() {
            Button($r('app.string.create_snapshot'))
              .layoutWeight(1)
              .height(40)
              .onClick(() => {
                if (!this.checkPC()) return
                if (this.checkNeedShutdown()) return
                if (this.checkNeedRestart()) return
                
                this.snapshotNameInput = ''
                this.createSnapshotDialogController.open()
              })
              .enabled(!this.isLoading && !this.isVmRunning && !this.needRestart && !this.globalTaskRunning)

            Blank().width(12)

            Button(getContext(this).resourceManager.getStringSync($r('app.string.btn_batch_delete').id) + ` (${this.selectedSnapshots.size})`)
              .layoutWeight(1)
              .height(40)
              .backgroundColor('#E74C3C')
              .fontColor(Color.White)
              .enabled(this.selectedSnapshots.size > 0 && !this.isLoading && !this.isVmRunning && !this.needRestart && !this.globalTaskRunning)
              .onClick(() => this.batchDeleteSnapshots())
          }
          .width('100%')
          .margin({ top: 16 })
          
          // VM è¿è¡Œä¸­æç¤ºï¼ˆå¿«ç…§åŒºåŸŸï¼‰
          if (this.isVmRunning) {
            Row() {
              SymbolGlyph($r('sys.symbol.info_circle'))
                .fontSize(14)
                .fontColor(['#E67E22'])
              Text($r('app.string.msg_vm_running_snapshot'))
                .fontSize(11)
                .fontColor('#E67E22')
                .margin({ left: 6 })
            }
            .width('100%')
            .margin({ top: 8 })
            .padding(8)
            .backgroundColor('#FFF8E7')
            .borderRadius(6)
          }
        }
        .width('100%')
        .margin({ top: 24 })
      }
      .padding(16)
    }
    .width('100%')
    .height('100%')
    .align(Alignment.TopStart)
  }

  @Builder
  buildDetailRow(label: Resource | string, value: string) {
    Row() {
      Text(label)
        .fontSize(12)
        .fontColor($r('sys.color.ohos_id_color_text_secondary'))
        .width(100)
      Text(value)
        .fontSize(12)
        .fontColor($r('sys.color.ohos_id_color_text_primary'))
        .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
  }

  @Builder
  buildCreateSnapshotContent() {
    Column() {
      TextInput({
        placeholder: $r('app.string.placeholder_snapshot_name'),
        text: $$this.snapshotNameInput
      })
        .width('100%')
        .height(40)
        .margin({ bottom: 8 })
      
      Text($r('app.string.msg_snapshot_name_duplicate'))
        .fontSize(11)
        .fontColor($r('sys.color.ohos_id_color_text_tertiary'))
    }
    .width('100%')
    .padding(16)
  }

  @Builder
  buildDetailContent() {
    if (this.detailInfo) {
      Scroll() {
        Column() {
          // æ–‡ä»¶æ ¼å¼
          this.buildDetailRow($r('app.string.label_file_format'), this.detailInfo.fileFormat)
          Divider().color($r('sys.color.ohos_id_color_list_separator'))

          // è™šæ‹Ÿå¤§å°
          this.buildDetailRow($r('app.string.virtual_size'), this.formatSize(this.detailInfo.virtualSize))
          Divider().color($r('sys.color.ohos_id_color_list_separator'))

          // å®é™…å ç”¨
          this.buildDetailRow($r('app.string.disk_size'), this.formatSize(this.detailInfo.diskSize))
          Divider().color($r('sys.color.ohos_id_color_list_separator'))

          // ç°‡å¤§å°
          if (this.detailInfo.clusterSize) {
            this.buildDetailRow($r('app.string.label_cluster_size'), this.formatSize(this.detailInfo.clusterSize))
            Divider().color($r('sys.color.ohos_id_color_list_separator'))
          }

          // å…¼å®¹ç‰ˆæœ¬
          if (this.detailInfo.compat) {
            this.buildDetailRow($r('app.string.label_compat'), this.detailInfo.compat)
            Divider().color($r('sys.color.ohos_id_color_list_separator'))
          }

          // Lazy Refcounts
          if (this.detailInfo.lazyRefcounts !== undefined) {
            this.buildDetailRow($r('app.string.label_lazy_refcounts'), this.detailInfo.lazyRefcounts ? getContext(this).resourceManager.getStringSync($r('app.string.status_enabled').id) : getContext(this).resourceManager.getStringSync($r('app.string.status_disabled').id))
            Divider().color($r('sys.color.ohos_id_color_list_separator'))
          }

          // Extended L2
          if (this.detailInfo.extendedL2 !== undefined) {
            this.buildDetailRow($r('app.string.label_extended_l2'), this.detailInfo.extendedL2 ? getContext(this).resourceManager.getStringSync($r('app.string.status_enabled').id) : getContext(this).resourceManager.getStringSync($r('app.string.status_disabled').id))
            Divider().color($r('sys.color.ohos_id_color_list_separator'))
          }

          // Refcount Bits
          if (this.detailInfo.refcountBits) {
            this.buildDetailRow($r('app.string.label_refcount_bits'), this.detailInfo.refcountBits.toString())
            Divider().color($r('sys.color.ohos_id_color_list_separator'))
          }

          // é•œåƒçŠ¶æ€
          if (this.detailInfo.corrupt !== undefined) {
            this.buildDetailRow($r('app.string.label_image_status'), this.detailInfo.corrupt ? getContext(this).resourceManager.getStringSync($r('app.string.status_corrupt').id) : getContext(this).resourceManager.getStringSync($r('app.string.status_normal').id))
          }
        }
        .width('100%')
        .padding(16)
      }
      .width('100%')
      .constraintSize({ maxHeight: 400 })
    } else {
      Text($r('app.string.msg_no_details'))
        .fontSize(12)
        .fontColor($r('sys.color.ohos_id_color_text_secondary'))
        .padding(16)
    }
  }

}
