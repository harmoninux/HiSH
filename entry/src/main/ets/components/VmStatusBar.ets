import { hilog } from '@kit.PerformanceAnalysisKit'
import { CustomContentDialog } from '@kit.ArkUI'
import QemuAgent, { CpuStats } from '../lib/QemuAgent'
import { QemuAgentManager, AgentPriority } from '../lib/QemuAgentManager'
import appOption from '../model/appOption'
import { util } from '@kit.ArkTS'

const DOMAIN = 0x0000

// è™šæ‹ŸæœºçŠ¶æ€ä¿¡æ¯
interface VmStatus {
  agentConnected: boolean
  hostname: string
  cpuCount: number
  cpuUsage: number
  memoryTotal: number
  memoryUsage: number
  diskTotal: number
  diskUsed: number
  diskUsage: number
  swapTotal: number
  swapUsage: number
  sshRunning: boolean
}

// æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯
interface FilesystemInfo {
  mountpoint: string
  type: string
  'used-bytes'?: number
  'total-bytes'?: number
}

// æ˜¾ç¤ºè®¾ç½®
interface DisplaySettings {
  masterSwitch: boolean
  showAgent: boolean
  showHostname: boolean
  showCpu: boolean
  showMemory: boolean
  showDisk: boolean
  showSwap: boolean
  showSsh: boolean
  refreshInterval: number
}

// åˆå§‹åŒ–æŒä¹…åŒ–è®¾ç½®
PersistentStorage.persistProp('VmStatusBarSettings', {
  masterSwitch: false,
  showAgent: true,
  showHostname: true,
  showCpu: true,
  showMemory: true,
  showDisk: true,
  showSwap: true,
  showSsh: true,
  refreshInterval: 15000
})

// æ ¼å¼åŒ–å­—èŠ‚ä¸ºå¯è¯»æ ¼å¼
// è§„åˆ™ï¼šå°äº1Gç”¨MBï¼Œå¤§äºç­‰äº1Gç”¨GBï¼ŒGBä¿ç•™2ä½å°æ•°
function formatBytes(bytes: number, useGB: boolean = false): string {
  if (bytes <= 0) return '-'
  const gb = bytes / (1024 * 1024 * 1024)
  const mb = bytes / (1024 * 1024)
  
  if (gb >= 1) {
    return `${gb.toFixed(2)}GB`
  } else if (mb >= 1) {
    return `${Math.round(mb)}MB`
  }
  return `${Math.round(bytes / 1024)}KB`
}

// æ ¼å¼åŒ–å­—èŠ‚ä¸º GBï¼Œä¿ç•™ 2 ä½å°æ•°
function formatBytesToGB(bytes: number): string {
  if (bytes <= 0) return '-'
  const gb = bytes / (1024 * 1024 * 1024)
  return `${gb.toFixed(2)}GB`
}

@Component
export struct VmStatusBar {
  @StorageProp(appOption.appTempDir) appTempDir: string = ''
  @Watch('onEmulatorStatusChange') @StorageProp(appOption.currentEmulatorStatus) currentEmulatorStatus: string = ''
  @Watch('onPowerManagementChange') @StorageProp(appOption.isPowerManagementOpen) isPowerManagementOpen: boolean = false
  
  @State status: VmStatus = {
    agentConnected: false,
    hostname: '-',
    cpuCount: 0,
    cpuUsage: 0,
    memoryTotal: 0,
    memoryUsage: 0,
    diskTotal: 0,
    diskUsed: 0,
    diskUsage: 0,
    swapTotal: 0,
    swapUsage: 0,
    sshRunning: false
  }
  
  @StorageLink('VmStatusBarSettings') @Watch('onSettingsChange') settings: DisplaySettings = {
    masterSwitch: false,
    showAgent: true,
    showHostname: true,
    showCpu: true,
    showMemory: true,
    showDisk: true,
    showSwap: true,
    showSsh: true,
    refreshInterval: 15000
  }
  
  @State isRefreshing: boolean = false
  @State isForceReconnecting: boolean = false
  
  private qgaAgent: QemuAgent | null = null
  private refreshTimer: number = -1
  private isComponentActive: boolean = true
  
  private lastCpuStats: CpuStats | null = null
  
  aboutToAppear() {
    this.isComponentActive = true
    this.initAgent()
  }
  
  aboutToDisappear() {
    this.isComponentActive = false
    this.stopRefreshTimer()
    if (this.qgaAgent) {
      this.qgaAgent.disconnect()
    }
  }
  
  onSettingsChange() {
    // masterSwitch æ§åˆ¶æ˜¾ç¤ºå’Œè‡ªåŠ¨åˆ·æ–°
    if (this.settings.masterSwitch) {
      // å¼€å¯ï¼šé‡ç½®ç»Ÿè®¡çŠ¶æ€ï¼Œç«‹å³åˆ·æ–°ä¸€æ¬¡ï¼Œå¯åŠ¨å®šæ—¶å™¨
      this.lastCpuStats = null
      this.refreshStatus()
      this.startRefreshTimer()
    } else {
      // å…³é—­ï¼šåœæ­¢å®šæ—¶å™¨
      this.stopRefreshTimer()
    }
  }
  
  /**
   * è™šæ‹ŸæœºçŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨å¤„ç† Agent è¿æ¥
   * å½“çŠ¶æ€å˜ä¸º RUNNING æˆ– REBOOTING æ—¶ï¼Œè‡ªåŠ¨å°è¯•è¿æ¥ Agent
   */
  onEmulatorStatusChange() {
    hilog.info(DOMAIN, 'VmStatusBar', 'è™šæ‹ŸæœºçŠ¶æ€å˜åŒ–: %{public}s', this.currentEmulatorStatus)
    
    if (this.currentEmulatorStatus === 'RUNNING') {
      // è™šæ‹Ÿæœºå¼€å§‹è¿è¡Œï¼Œå»¶è¿Ÿåå°è¯•é¦–æ¬¡è¿æ¥ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
      setTimeout((): void => {
        if (this.isComponentActive && this.currentEmulatorStatus === 'RUNNING' && !this.isPowerManagementOpen) {
          this.initialConnectWithRetry()
        }
      }, 5000)  // ç»Ÿä¸€ç­‰å¾… 5 ç§’ï¼Œç­‰å¾… Guest Agent æœåŠ¡å¯åŠ¨
    } else if (this.currentEmulatorStatus === 'REBOOTING') {
      // é‡å¯ä¸­çŠ¶æ€ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´åå°è¯•åˆ·æ–°
      this.status.agentConnected = false
      setTimeout((): void => {
        if (this.isComponentActive && !this.isPowerManagementOpen) {
          // åªè¦çŠ¶æ€ä¸æ˜¯ SHUTDOWN/PAUSED å°±å°è¯•åˆ·æ–°
          const status = this.currentEmulatorStatus
          if (status === 'RUNNING' || status === 'REBOOTING' || status === 'ABNORMAL') {
            this.initialConnectWithRetry()  // é‡å¯åä¹Ÿä½¿ç”¨å¸¦é‡è¯•çš„è¿æ¥
          }
        }
      }, 8000) // é‡å¯éœ€è¦æ›´é•¿ç­‰å¾…æ—¶é—´
    } else if (this.currentEmulatorStatus === 'ABNORMAL') {
      // å¼‚å¸¸çŠ¶æ€ï¼Œå…è®¸åˆ·æ–°ä»¥ä¾¿æ£€æµ‹æ¢å¤
      this.status.agentConnected = false
      if (this.settings.masterSwitch) {
        this.startRefreshTimer()
      }
    } else {
      // å…³æœºæˆ–æš‚åœçŠ¶æ€ï¼Œæ ‡è®° Agent ä¸ºæ–­å¼€
      this.status.agentConnected = false
      this.stopRefreshTimer()
    }
  }
  
  /**
   * è™šæ‹Ÿæœºå¯åŠ¨åçš„é¦–æ¬¡è¿æ¥ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
   * ä¸å— masterSwitch å½±å“ï¼Œç¡®ä¿é¦–æ¬¡è¿æ¥æˆåŠŸ
   */
  private async initialConnectWithRetry() {
    const maxAttempts = 10     // æœ€å¤š 10 æ¬¡
    const retryInterval = 2000 // é—´éš” 2 ç§’
    
    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
      // æ£€æŸ¥ç»„ä»¶çŠ¶æ€
      if (!this.isComponentActive) return
      if (this.currentEmulatorStatus !== 'RUNNING' && this.currentEmulatorStatus !== 'REBOOTING') return
      if (this.isPowerManagementOpen) return
      
      hilog.info(DOMAIN, 'VmStatusBar', 'é¦–æ¬¡è¿æ¥å°è¯• %{public}d/%{public}d', attempt, maxAttempts)
      
      // å°è¯•åˆ·æ–°ï¼ˆå†…éƒ¨ä¼šè°ƒç”¨ acquire/ping/releaseï¼‰
      await this.refreshStatus()
      
      // æ£€æŸ¥æ˜¯å¦æˆåŠŸ
      if (this.status.agentConnected) {
        hilog.info(DOMAIN, 'VmStatusBar', 'é¦–æ¬¡è¿æ¥æˆåŠŸï¼Œå…±å°è¯• %{public}d æ¬¡', attempt)
        break
      }
      
      // å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•
      if (attempt < maxAttempts) {
        await new Promise<void>((resolve: () => void) => setTimeout(resolve, retryInterval))
      }
    }
    
    // å¦‚æœå¼€å¯äº†ç›‘æ§ï¼Œå¯åŠ¨å®šæ—¶åˆ·æ–°
    if (this.settings.masterSwitch) {
      this.startRefreshTimer()
    }
  }
  
  /**
   * ç”µæºç®¡ç†ç•Œé¢çŠ¶æ€å˜åŒ–æ—¶çš„å¤„ç†
   * ç”µæºç®¡ç†ä¼˜å…ˆçº§æœ€é«˜ï¼Œç›‘æ§æ¡å¿…é¡»è®©æ­¥
   */
  onPowerManagementChange() {
    if (this.isPowerManagementOpen) {
      // ç”µæºç®¡ç†æ‰“å¼€ï¼šç«‹å³åœæ­¢åˆ·æ–°å¹¶æ–­å¼€è¿æ¥
      hilog.info(DOMAIN, 'VmStatusBar', 'ç”µæºç®¡ç†æ‰“å¼€ï¼Œç›‘æ§æ¡è®©æ­¥')
      this.stopRefreshTimer()
      if (this.qgaAgent) {
        this.qgaAgent.disconnect()
      }
      this.status.agentConnected = false
    } else {
      // ç”µæºç®¡ç†å…³é—­ï¼šå»¶è¿Ÿ 1 ç§’åæ¢å¤
      hilog.info(DOMAIN, 'VmStatusBar', 'ç”µæºç®¡ç†å…³é—­ï¼Œç›‘æ§æ¡æ¢å¤')
      setTimeout((): void => {
        if (this.isComponentActive && this.currentEmulatorStatus === 'RUNNING' && !this.isPowerManagementOpen) {
          this.refreshStatus()
          if (this.settings.masterSwitch) {
            this.startRefreshTimer()
          }
        }
      }, 1000)
    }
  }
  
  private async initAgent() {
    if (!this.appTempDir) return
    
    // ä½¿ç”¨è¿æ¥ç®¡ç†å™¨è·å–è¿æ¥
    this.qgaAgent = await QemuAgentManager.acquire('VmStatusBar', AgentPriority.LOW)
    
    if (this.qgaAgent) {
      // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
      await this.refreshStatus()
      
      // é‡Šæ”¾è¿æ¥ä¾›å…¶ä»–ç»„ä»¶ä½¿ç”¨
      await QemuAgentManager.release('VmStatusBar')
      this.qgaAgent = null
    }
    
    // å§‹ç»ˆå¯åŠ¨å®šæ—¶åˆ·æ–°ï¼Œä¿æŒ Agent è¿æ¥çŠ¶æ€åŒæ­¥
    // å³ä½¿ç”¨æˆ·å…³é—­äº†ç›‘æ§ä¿¡æ¯æ˜¾ç¤ºï¼Œä¹Ÿéœ€è¦å®šæœŸæ£€æŸ¥ Agent çŠ¶æ€
    this.startRefreshTimer()
  }
  
  private startRefreshTimer() {
    this.stopRefreshTimer()
    
    // è®¾ç½®åˆ·æ–°é—´éš”ï¼šå¯ç”¨ç›‘æ§æ—¶ä½¿ç”¨ç”¨æˆ·è®¾ç½®ï¼Œå¦åˆ™ä½¿ç”¨è¾ƒé•¿çš„é»˜è®¤é—´éš”ï¼ˆ30ç§’ï¼‰ä¿æŒçŠ¶æ€åŒæ­¥
    const interval = this.settings.masterSwitch ? this.settings.refreshInterval : 30000
    
    this.refreshTimer = setInterval((): void => {
      if (this.isComponentActive) {
        this.refreshStatus()
      }
    }, interval)
  }
  
  private stopRefreshTimer() {
    if (this.refreshTimer !== -1) {
      clearInterval(this.refreshTimer)
      this.refreshTimer = -1
    }
  }

  /**
   * å¼ºåˆ¶é‡è¿ Agent
   * æ¸…é™¤æ‰€æœ‰å†å²é˜»å¡ï¼Œå¼ºåˆ¶æ–­å¼€å¹¶é‡æ–°å»ºç«‹å¹²å‡€çš„é€šä¿¡æ¥å£
   */
  private async forceReconnectAgent() {
    // é˜²æ­¢é‡å¤ç‚¹å‡»
    if (this.isForceReconnecting) return
    this.isForceReconnecting = true
    
    hilog.info(DOMAIN, 'VmStatusBar', 'å¼€å§‹å¼ºåˆ¶é‡è¿ Agent...')
    
    try {
      // 1. åœæ­¢å®šæ—¶å™¨ï¼Œé¿å…å†²çª
      this.stopRefreshTimer()
      
      // 2. å½»åº•é”€æ¯æ—§è¿æ¥
      if (this.qgaAgent) {
        try {
          await this.qgaAgent.disconnect()
        } catch (e) {
          hilog.warn(DOMAIN, 'VmStatusBar', 'æ–­å¼€æ—§è¿æ¥æ—¶å‡ºé”™')
        }
        this.qgaAgent = null
      }
      
      // 3. é‡ç½®çŠ¶æ€
      this.status.agentConnected = false
      this.lastCpuStats = null
      
      // 4. ç­‰å¾…èµ„æºé‡Šæ”¾
      await new Promise<void>((resolve: () => void) => setTimeout(resolve, 500))
      
      // 5. é‡æ–°åˆ›å»º Agent å®ä¾‹
      if (!this.appTempDir) return
      const qgaSocket = this.appTempDir + '/qga_socket'
      this.qgaAgent = new QemuAgent(qgaSocket)
      
      // 6. å°è¯•è¿æ¥ï¼ˆæœ€å¤š 3 æ¬¡é‡è¯•ï¼Œé—´éš” 3 ç§’ï¼‰
      for (let attempt = 0; attempt < 3; attempt++) {
        if (!this.isComponentActive) return
        
        try {
          const connected = await this.qgaAgent.connect()
          if (connected) {
            const ping = await this.qgaAgent.ping()
            if (ping) {
              this.status.agentConnected = true
              hilog.info(DOMAIN, 'VmStatusBar', 'Agent å¼ºåˆ¶é‡è¿æˆåŠŸ')
              
              // è·å–æ•°æ®
              await this.refreshStatus()
              
              // å¦‚æœå¯ç”¨äº†ç›‘æ§ï¼Œé‡æ–°å¯åŠ¨å®šæ—¶å™¨
              if (this.settings.masterSwitch) {
                this.startRefreshTimer()
              }
              return
            }
          }
        } catch (e) {
          hilog.warn(DOMAIN, 'VmStatusBar', 'é‡è¿å°è¯• %{public}d å¤±è´¥', attempt + 1)
        }
        
        // ç­‰å¾…åé‡è¯•
        if (attempt < 2) {
          await new Promise<void>((resolve: () => void) => setTimeout(resolve, 3000))
        }
      }
      
      hilog.error(DOMAIN, 'VmStatusBar', 'Agent å¼ºåˆ¶é‡è¿å¤±è´¥')
    } finally {
      this.isForceReconnecting = false
    }
  }

  async refreshStatus() {
    // ç”µæºç®¡ç†ä¼˜å…ˆçº§æœ€é«˜ï¼Œç›´æ¥è¿”å›
    if (this.isPowerManagementOpen) return
    
    if (!this.isComponentActive || this.isRefreshing) return
    // åªæœ‰å…³æœºå’Œæš‚åœçŠ¶æ€ä¸åˆ·æ–°ï¼Œå…¶ä»–çŠ¶æ€ï¼ˆåŒ…æ‹¬ REBOOTINGã€ABNORMALï¼‰éƒ½å°è¯•åˆ·æ–°
    if (this.currentEmulatorStatus === 'SHUTDOWN' || 
        this.currentEmulatorStatus === 'PAUSED' ||
        this.currentEmulatorStatus === '') {
      this.status.agentConnected = false
      return
    }
    
    this.isRefreshing = true
    
    try {
      // ä½¿ç”¨è¿æ¥ç®¡ç†å™¨è·å–è¿æ¥ï¼ˆä½ä¼˜å…ˆçº§ï¼Œå¯è¢«ç”µæºç®¡ç†æŠ¢å ï¼‰
      const agent = await QemuAgentManager.acquire('VmStatusBar', AgentPriority.LOW, 3000)
      if (!agent) {
        this.status.agentConnected = false
        return
      }
      
      // å†æ¬¡æ£€æŸ¥ç”µæºç®¡ç†çŠ¶æ€ï¼ˆå¯èƒ½åœ¨ç­‰å¾…æœŸé—´æ‰“å¼€äº†ï¼‰
      if (this.isPowerManagementOpen) {
        await QemuAgentManager.release('VmStatusBar')
        return
      }
      
      // Ping æµ‹è¯•
      const pingResult = await agent.ping()
      this.status.agentConnected = pingResult
      
      if (!pingResult) {
        await QemuAgentManager.release('VmStatusBar')
        return
      }
      
      // å¦‚æœå½“å‰çŠ¶æ€æ˜¯å¼‚å¸¸æˆ–é‡å¯ä¸­ï¼Œè¿æ¥æˆåŠŸåè‡ªåŠ¨æ¢å¤ä¸º RUNNING
      const currentStatus = this.currentEmulatorStatus
      if (currentStatus === 'ABNORMAL' || currentStatus === 'REBOOTING') {
        AppStorage.setOrCreate(appOption.currentEmulatorStatus, 'RUNNING')
        hilog.info(DOMAIN, 'VmStatusBar', 'çŠ¶æ€å·²ä» %{public}s æ¢å¤ä¸º RUNNING', currentStatus)
      }
      
      // è·å–ä¸»æœºå
      const hostname = await agent.getHostName()
      if (hostname) {
        this.status.hostname = hostname
      }
      
      // è·å– vCPU æ•°é‡
      const vcpus: ESObject[] | null = await agent.getVcpus()
      if (vcpus) {
        this.status.cpuCount = vcpus.length
      }
      
      // è·å–æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯
      const fsInfo: ESObject[] | null = await agent.getFilesystemInfo()
      if (fsInfo && fsInfo.length > 0) {
        // æ‰¾æ ¹æ–‡ä»¶ç³»ç»Ÿ
        for (let i = 0; i < fsInfo.length; i++) {
          const fsi = fsInfo[i] as Record<string, ESObject>
          if (fsi['mountpoint'] === '/') {
            const total = fsi['total-bytes'] as number
            const used = fsi['used-bytes'] as number
            this.status.diskTotal = total || 0
            this.status.diskUsed = used || 0
            if (this.status.diskTotal > 0) {
              this.status.diskUsage = Math.round((this.status.diskUsed / this.status.diskTotal) * 100)
            }
            break
          }
        }
      }
      
      // è·å–å†…å­˜ä¿¡æ¯ (å§‹ç»ˆè·å–ï¼Œä»¥æ»¡è¶³æ ¸å¿ƒæ•°æ®è¦æ±‚)
      const memInfo: Record<string, number> | null = await agent.getMemoryInfo()
      if (memInfo) {
        this.status.memoryTotal = memInfo['MemTotal'] || 0
        const memAvailable = memInfo['MemAvailable'] || 0
        if (this.status.memoryTotal > 0) {
          const memUsed = this.status.memoryTotal - memAvailable
          this.status.memoryUsage = Math.round((memUsed / this.status.memoryTotal) * 100)
        }
        
        // SWAP
        this.status.swapTotal = memInfo['SwapTotal'] || 0
        const swapFree = memInfo['SwapFree'] || 0
        if (this.status.swapTotal > 0) {
          const swapUsed = this.status.swapTotal - swapFree
          this.status.swapUsage = Math.round((swapUsed / this.status.swapTotal) * 100)
        }
      }

      // å¦‚æœå¯ç”¨ç›‘æ§ï¼Œè·å–åŠ¨æ€æ•°æ®
      if (this.settings.masterSwitch) {
        // è·å– CPU ç»Ÿè®¡ä¿¡æ¯å¹¶è®¡ç®—ä½¿ç”¨ç‡
        const cpuStats: CpuStats | null = await agent.getCpuStats()
        if (cpuStats) {
          if (this.lastCpuStats) {
            const diffTotal = cpuStats.total - this.lastCpuStats.total
            const diffIdle = cpuStats.idle - this.lastCpuStats.idle
            if (diffTotal > 0) {
               this.status.cpuUsage = Math.round(((diffTotal - diffIdle) / diffTotal) * 100)
            }
          }
           const newCpuStats: CpuStats = { total: cpuStats.total, idle: cpuStats.idle }
           this.lastCpuStats = newCpuStats
        }
        
        // æ£€æŸ¥ SSH
        this.status.sshRunning = await agent.isSshRunning()
      }
      
      // é‡Šæ”¾è¿æ¥
      await QemuAgentManager.release('VmStatusBar')
    } catch (e) {
      hilog.error(DOMAIN, 'VmStatusBar', 'åˆ·æ–°çŠ¶æ€å¤±è´¥: %{public}s', JSON.stringify(e))
      this.status.agentConnected = false
      // ç¡®ä¿é‡Šæ”¾è¿æ¥
      try { await QemuAgentManager.release('VmStatusBar') } catch (e2) {}
    } finally {
      this.isRefreshing = false
    }
  }
  
  build() {
    Row({ space: 4 }) {
      // Agent çŠ¶æ€
      if (this.settings.showAgent) {
        Text(this.status.agentConnected ? 'ğŸŸ¢' : 'ğŸ”´')
          .fontSize(12)
      }
      
      // ç›‘æ§é¡¹å§‹ç»ˆæ˜¾ç¤ºï¼ˆAgent æœªè¿æ¥æ—¶æ˜¾ç¤º '-'ï¼‰
      if (this.settings.masterSwitch) {
        // ä¸»æœºå
        if (this.settings.showHostname) {
          Text(`ğŸ–¥ï¸ ${this.status.agentConnected ? this.status.hostname : '-'}`)
            .fontSize(12)
            .fontColor('#FFFFFF')
        }
        
        // CPU
        if (this.settings.showCpu) {
          Text(`ğŸ”² ${this.status.agentConnected ? this.status.cpuCount + getContext(this).resourceManager.getStringSync($r('app.string.label_cores').id) + ' ' + this.status.cpuUsage + '%' : '-'}`)
            .fontSize(12)
            .fontColor('#FFFFFF')
        }
        
        // å†…å­˜
        if (this.settings.showMemory) {
          Text(`ğŸ”· ${this.status.agentConnected ? formatBytes(this.status.memoryTotal, true) + ' ' + this.status.memoryUsage + '%' : '-'}`)
            .fontSize(12)
            .fontColor('#FFFFFF')
        }
        
        // ç¡¬ç›˜
        if (this.settings.showDisk) {
          Text(`ğŸ“¦ ${this.status.agentConnected ? formatBytesToGB(this.status.diskUsed) + '/' + formatBytesToGB(this.status.diskTotal) + ' ' + this.status.diskUsage + '%' : '-'}`)
            .fontSize(12)
            .fontColor('#FFFFFF')
        }
        
        // SWAP (ä»…åœ¨æœ‰æ•°æ®æ—¶æ˜¾ç¤º)
        if (this.settings.showSwap) {
          if (this.status.agentConnected && this.status.swapTotal > 0) {
            Text(`ğŸ’« ${formatBytes(this.status.swapTotal, true)} ${this.status.swapUsage}%`)
              .fontSize(12)
              .fontColor('#FFFFFF')
          } else if (!this.status.agentConnected) {
            Text(`ğŸ’« -`)
              .fontSize(12)
              .fontColor('#FFFFFF')
          }
        }
        
        // SSH
        if (this.settings.showSsh) {
          if (this.status.agentConnected) {
            Text(this.status.sshRunning ? 'ğŸ”' : 'ğŸ”’')
              .fontSize(12)
          } else {
            Text('ğŸ”’ -')
              .fontSize(12)
              .fontColor('#FFFFFF')
          }
        }
      }
      
      // å¸®åŠ©æŒ‰é’®
      Text('â“')
        .fontSize(12)
        .fontColor('#FFFFFF')
        .onClick(() => {
          new CustomDialogController({
            builder: CustomContentDialog({
              primaryTitle: $r('app.string.dialog_vm_status'),
              contentBuilder: () => {
                this.dialogBuilder()
              }
            })
          }).open()
        })
    }
    .padding({ left: 8, right: 8 })
  }
  
  @Builder
  dialogBuilder() {
    Scroll() {
      Column({ space: 12 }) {
      // çŠ¶æ€åˆ—è¡¨
      Column({ space: 8 }) {
        // æ€»å¼€å…³
        Row() {
          Toggle({ type: ToggleType.Checkbox, isOn: this.settings.masterSwitch })
            .onChange((isOn: boolean) => {
              this.settings.masterSwitch = isOn
            })
          Text($r('app.string.label_enable_monitor'))
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ left: 8 })
        }
        .width('100%')
        .padding({ bottom: 8 })
        
        Divider()
      
        // Agent (å¼ºåˆ¶æ˜¾ç¤ºï¼Œå›¾æ ‡æ ¹æ®çŠ¶æ€å˜åŒ–)
        Row({ space: 8 }) {
          Toggle({ type: ToggleType.Checkbox, isOn: true })
            .enabled(false) // ç¦ç”¨äº¤äº’
          Text(this.status.agentConnected ? 'ğŸŸ¢' : 'ğŸ”´')
            .fontSize(16)
          Text(`${getContext(this).resourceManager.getStringSync($r('app.string.label_agent').id)}ï¼š${this.status.agentConnected ? getContext(this).resourceManager.getStringSync($r('app.string.status_connected').id) : getContext(this).resourceManager.getStringSync($r('app.string.status_disconnected').id)}`)
            .fontSize(14)
          
          // æœªè¿æ¥æ—¶æ˜¾ç¤ºé‡è¯•é“¾æ¥
          if (!this.status.agentConnected) {
            Text(this.isForceReconnecting ? getContext(this).resourceManager.getStringSync($r('app.string.status_reconnecting').id) : getContext(this).resourceManager.getStringSync($r('app.string.btn_retry').id))
              .fontSize(14)
              .fontColor(this.isForceReconnecting ? '#999999' : '#007AFF')
              .enabled(!this.isForceReconnecting)
              .onClick(() => {
                this.forceReconnectAgent()
              })
          }
        }
        
        // ç›‘æ§é¡¹å§‹ç»ˆæ˜¾ç¤º
        if (this.settings.masterSwitch) {
          // ä¸»æœºå
          this.statusRow(this.settings.showHostname, 'ğŸ–¥ï¸', getContext(this).resourceManager.getStringSync($r('app.string.label_hostname').id),
            this.status.agentConnected ? this.status.hostname : '-',
            (checked: boolean) => { this.settings.showHostname = checked })
          
          // CPU
          this.statusRow(this.settings.showCpu, 'ğŸ”²', 'CPU',
            this.status.agentConnected 
              ? `${this.status.cpuCount} ${getContext(this).resourceManager.getStringSync($r('app.string.label_cores2').id)} ${this.status.cpuUsage}%` 
              : '-',
            (checked: boolean) => { this.settings.showCpu = checked })
          
          // å†…å­˜
          this.statusRow(this.settings.showMemory, 'ğŸ”·', getContext(this).resourceManager.getStringSync($r('app.string.label_memory2').id),
            this.status.agentConnected 
              ? `${formatBytes(this.status.memoryTotal, true)}${getContext(this).resourceManager.getStringSync($r('app.string.label_usage2').id)} ${this.status.memoryUsage}%` 
              : '-',
            (checked: boolean) => { this.settings.showMemory = checked })
          
          // ç¡¬ç›˜
          this.statusRow(this.settings.showDisk, 'ğŸ“¦', getContext(this).resourceManager.getStringSync($r('app.string.label_disk').id),
            this.status.agentConnected 
              ? `${getContext(this).resourceManager.getStringSync($r('app.string.label_used2').id)} ${formatBytesToGB(this.status.diskUsed)} ${getContext(this).resourceManager.getStringSync($r('app.string.label_total2').id)} ${formatBytesToGB(this.status.diskTotal)} (${this.status.diskUsage}%)` 
              : '-',
            (checked: boolean) => { this.settings.showDisk = checked })
          
          // SWAP
          this.statusRow(this.settings.showSwap, 'ğŸ’«', 'SWAP',
            this.status.agentConnected && this.status.swapTotal > 0 
              ? `${getContext(this).resourceManager.getStringSync($r('app.string.label_total3').id)} ${formatBytes(this.status.swapTotal, true)}${getContext(this).resourceManager.getStringSync($r('app.string.label_usage2').id)} ${this.status.swapUsage}%` 
              : '-',
            (checked: boolean) => { this.settings.showSwap = checked })
          
          // SSH
          this.statusRow(this.settings.showSsh, this.status.sshRunning ? 'ğŸ”' : 'ğŸ”’', 'SSH',
            this.status.agentConnected 
              ? (this.status.sshRunning ? getContext(this).resourceManager.getStringSync($r('app.string.status_ssh_on').id) : getContext(this).resourceManager.getStringSync($r('app.string.status_ssh_off').id)) 
              : '-',
            (checked: boolean) => { this.settings.showSsh = checked })
        } else {
           Text($r('app.string.msg_enable_monitor_hint'))
             .fontSize(14)
             .fontColor('#999999')
             .margin({ top: 8, bottom: 8 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')
      
      Divider()
      
      // åˆ·æ–°é—´éš”è®¾ç½®
      Column({ space: 8 }) {
        Text($r('app.string.label_refresh_settings'))
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
        
        Row() {
          Text($r('app.string.label_refresh_interval'))
            .fontSize(14)
          Select([
            { value: $r('app.string.option_15s') },
            { value: $r('app.string.option_30s') },
            { value: $r('app.string.option_45s') },
            { value: $r('app.string.option_60s') }
          ])
            .value(this.getIntervalLabel())
            .onSelect((index: number) => {
              const intervals = [15000, 30000, 45000, 60000]
              this.settings.refreshInterval = intervals[index]
              if (this.settings.masterSwitch) {
                this.startRefreshTimer()
              }
            })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')
      }
      .padding(16)
      .width('100%')
    }
    .width('100%')
    .scrollBar(BarState.Auto)
    .align(Alignment.Top)
  }
  
  @Builder
  statusRow(checked: boolean, icon: string, label: string, value: string, onChange: (checked: boolean) => void) {
    Row({ space: 8 }) {
      Toggle({ type: ToggleType.Checkbox, isOn: checked })
        .onChange(onChange)
      Text(icon)
        .fontSize(16)
      Text(`${label}ï¼š${value}`)
        .fontSize(14)
    }
  }
  
  private getIntervalLabel(): string {
    const map: Record<number, string> = {
      15000: getContext(this).resourceManager.getStringSync($r('app.string.option_15s').id),
      30000: getContext(this).resourceManager.getStringSync($r('app.string.option_30s').id),
      45000: getContext(this).resourceManager.getStringSync($r('app.string.option_45s').id),
      60000: getContext(this).resourceManager.getStringSync($r('app.string.option_60s').id)
    }
    // é»˜è®¤å›é€€å€¼æ”¹ä¸º15ç§’
    return map[this.settings.refreshInterval] || getContext(this).resourceManager.getStringSync($r('app.string.option_15s').id)
  }
}

export default VmStatusBar
